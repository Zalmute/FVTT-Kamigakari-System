{"name":"Influence","permission":{"default":0,"qbUuGvCaFbrkiBWc":3},"type":"script","flags":{},"scope":"global","command":"var a = actor;\r\nif (a == null)\r\n    alert(\"You must use actor\");\r\nelse {\r\n\r\nvar m = $(\".message-sender:contains('\" + a.data.name + \"')\");\r\nvar d = m.parent().parent().find(\".dice-rolls\").last();\r\nvar modScore = d.parent().parent().find(\".dice-total\").text() - d.parent().parent().find(\".part-total\").text();\r\n\r\n\r\nvar actionDice = [];\r\nvar spiritDice = a.data.data.attributes.spirit_dice.value;\r\n\r\nvar dices = d.find(\"img\");\r\ndices.each(function() {\r\n    actionDice.push($(this).attr(\"data-dice\"));\r\n});\r\n\r\nvar content = \"<p>What do you change dice?<br><br>Action Dice<br>\";\r\n$(actionDice).each(element => {\r\n    content += '<img width=30 height=30 src=\"systems/kamigakari/assets/dice/' + actionDice[element] + '.PNG\">';\r\n});\r\ncontent += \"<br>Spirit Dice<br>\";\r\n$(spiritDice).each(element => {\r\n    content += '<img width=30 height=30 src=\"systems/kamigakari/assets/dice/' + spiritDice[element] + '.PNG\">';\r\n});\r\ncontent += \"<br></p><div style='display: flex; text-align: center'>\";\r\ncontent += \"<input type='text' placeholder='action' name='action'>\";\r\ncontent += \"<span> - </span>\";\r\ncontent += \"<input type='text' placeholder='spirit' name='spirit'></div><br>\";\r\n\r\n\r\nlet dialog1 = new Dialog({\r\n title: \"Influence\",\r\n content: content,\r\n buttons: {\r\n    \"cancel\": {\r\n        icon: '<i class=\"fas fa-times\"></i>',\r\n        label: \"cancel\",\r\n        callback: () => console.log(\"Canceled\")\r\n    },\r\n    \"change\": {\r\n        icon: '<i class=\"fas fa-check\"></i>',\r\n        label: \"Change\",\r\n        callback: () => {\r\n            var action = $(\"input[name=action]\").val();\r\n            var spirit = $(\"input[name=spirit]\").val();\r\n\r\n            if (action >= 1 && action <= 6 && spirit >= 1 && spirit <= 6) {\r\n                var actionIndex = actionDice.findIndex(element => element == action);\r\n                var spiritIndex = spiritDice.findIndex(element => element == spirit);\r\n\r\n                if (actionIndex == -1 || spiritIndex == -1) {\r\n                    alert(\"Not validated input\");\r\n                    return;\r\n                }\r\n\r\n                var tmp = actionDice[actionIndex];\r\n                actionDice[actionIndex] = spiritDice[spiritIndex];\r\n                spiritDice[spiritIndex] = tmp;\r\n\r\n                var formula = \"\";\r\n                $(actionDice).each(element => {\r\n                    formula += actionDice[element] + \"+\";\r\n                });\r\n                formula += modScore;\r\n                actor.update({\"data.attributes.spirit_dice.value\": spiritDice});\r\n                if (actor.sheet)\r\n                    actor.sheet.render();\r\n\r\n                var roll = new Roll(formula);\r\n                roll.roll();\r\n                roll.render().then(r => {\r\n                    ChatMessage.create({content: r, speaker: ChatMessage.getSpeaker({actor: actor})});\r\n                });\r\n\r\n            }\r\n\r\n        }\r\n    }\r\n },\r\n default: \"cancel\",\r\n close: () => console.log(\"This always is logged no matter which option is chosen\")\r\n});\r\n\r\ndialog1.render(true);\r\n\r\n\r\n}","author":"qbUuGvCaFbrkiBWc","img":"icons/svg/dice-target.svg","actorIds":[],"_id":"ANpRXhlt7ibWWGLl"}
